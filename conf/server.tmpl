{% if WWWREDIRECT == "tononwww" %}
server {
  listen  {{ CPANELIP }}:80;
  {% if IPVSIX == 1 }
  listen  [{{ CPIPVSIX }}]:80;
  {% endif %}
  {% if SSL == 1 }
  listen  {{ CPANELIP }}:443 ssl http2;
  {% if IPVSIX == 1 }
  listen  [{{ CPIPVSIX }}]:443 ssl http2;
  {% endif %}
  ssl_certificate {{ CPANELSSLCRT }};
  ssl_certificate_key {{ CPANELSSLKEY }};
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
  ssl_session_cache shared:SSL:10m;
  ssl_dhparam /etc/nginx/ssl/dhparam.pem;
  ssl_session_timeout  5m;
  {% if OCSP == 1 }
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate {{ CPANELCACERT }};
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;
  {% endif %}
  {% endif %}
  server_name www.{{ DOMAINNAME }};
  return 301 $scheme://{{ DOMAINNAME }}$request_uri;
}
{% endif %}
{% if WWWREDIRECT == "towww" %}
server {
  listen  {{ CPANELIP }}:80;
  {% if IPVSIX == 1 }
  listen  [{{ CPIPVSIX }}]:80;
  {% endif %}
  {% if SSL == 1 }
  listen  {{ CPANELIP }}:443 ssl http2;
  {% if IPVSIX == 1 }
  listen  [{{ CPIPVSIX }}]:443 ssl http2;
  {% endif %}
  ssl_certificate {{ CPANELSSLCRT }};
  ssl_certificate_key {{ CPANELSSLKEY }};
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
  ssl_session_cache shared:SSL:10m;
  ssl_dhparam /etc/nginx/ssl/dhparam.pem;
  ssl_session_timeout  5m;
  {% if OCSP == 1 }
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate {{ CPANELCACERT }};
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;
  {% endif %}
  {% endif %}
  server_name {{ DOMAINNAME }};
  return 301 $scheme://www.{{ DOMAINNAME }}$request_uri;
}
{% endif %}

server {
  listen    {{ CPANELIP }}:80;
  {% if IPVSIX == 1 }
  listen  [{{ CPIPVSIX }}]:80;
  {% endif %}
  server_name  {{ DOMAINLIST }};
  access_log /usr/local/apache/domlogs/{{ DOMAINNAME }} combined buffer=32k flush=5m;
  access_log /usr/local/apache/domlogs/{{ DOMAINNAME }}-bytes_log bytes_log buffer=32k flush=5m;
  {% if AUTOINDEX == 1 }
  autoindex on;
  {% endif %}
  {% if REDIRECT_TO_SSL == 1 }
  return 301 https://$host$request_uri;
  {% else %}
  {% if BLOCK_SQL_INJECTION == 1 }
  set $block_sql_injections 0;
  if ($query_string ~ "union.*select.*\(") {
  set $block_sql_injections 1;
  }
  if ($query_string ~ "union.*all.*select.*") {
  set $block_sql_injections 1;
  }
  if ($query_string ~ "concat.*\(") {
  set $block_sql_injections 1;
  }
  if ($block_sql_injections = 1) {
  return 403;
  }
  {% endif %}
  {% if BLOCK_FILE_INJECTION == 1 }
  set $block_file_injections 0;
  if ($query_string ~ "[a-zA-Z0-9_]=http://") {
   set $block_file_injections 1;
  }
  if ($query_string ~ "[a-zA-Z0-9_]=(\.\.//?)+") {
   set $block_file_injections 1;
  }
  if ($query_string ~ "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") {
   set $block_file_injections 1;
  }
  if ($block_file_injections = 1) {
   return 403;
  }
  {% endif %}
  {% if BLOCK_COMMON_EXPLOITS == 1 }
  set $block_common_exploits 0;
  if ($query_string ~ "(<|%3C).*script.*(>|%3E)") {
    set $block_common_exploits 1;
  }
  if ($query_string ~ "GLOBALS(=|\[|\%[0-9A-Z]{0,2})") {
    set $block_common_exploits 1;
  }
  if ($query_string ~ "_REQUEST(=|\[|\%[0-9A-Z]{0,2})") {
    set $block_common_exploits 1;
  }
  if ($query_string ~ "proc/self/environ") {
    set $block_common_exploits 1;
  }
  if ($query_string ~ "mosConfig_[a-zA-Z_]{1,21}(=|\%3D)") {
    set $block_common_exploits 1;
  }
  if ($query_string ~ "base64_(en|de)code\(.*\)") {
    set $block_common_exploits 1;
  }
  if ($block_common_exploits = 1) {
    return 403;
  }
  {% endif %}
  {% if BLOCK_SPAM == 1 }
  set $block_spam 0;
  if ($query_string ~ "\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b") {
    set $block_spam 1;
  }
  if ($query_string ~ "\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b") {
    set $block_spam 1;
  }
  if ($query_string ~ "\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b") {
    set $block_spam 1;
  }
  if ($query_string ~ "\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b") {
    set $block_spam 1;
  }
  if ($block_spam = 1) {
    return 403;
  }
  {% endif %}
  {% if BLOCK_BAD_USER_AGENT == 1 }
  set $block_user_agents 0;
  if ($http_user_agent ~ "Indy Library") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "libwww-perl") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "GetRight") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "GetWeb!") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "Go!Zilla") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "Download Demon") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "Go-Ahead-Got-It") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "TurnitinBot") {
    set $block_user_agents 1;
  }
  if ($http_user_agent ~ "GrabNet") {
    set $block_user_agents 1;
  }
  if ($block_user_agents = 1) {
    return 403;
  {% endif %
  include /etc/nginx/sites-enabled/{{ DOMAINNAME }}.include;
  {% endif %}
}

{% if SSL == 1 }
server {
   listen    {{ CPANELIP }}:443 ssl http2;
   {% if IPVSIX == 1 }
   listen    [{{ CPIPVSIX }}]:443 ssl http2;
   {% endif %}
   ssl_certificate {{ CPANELSSLCRT }};
   ssl_certificate_key {{ CPANELSSLKEY }};
   ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
   ssl_prefer_server_ciphers on;
   ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
   ssl_session_cache shared:SSL:10m;
   ssl_dhparam /etc/nginx/ssl/dhparam.pem;
   ssl_session_timeout  5m;
   {% if OCSP == 1 }
   ssl_stapling on;
   ssl_stapling_verify on;
   ssl_trusted_certificate {{ CPANELCACERT }};
   resolver 8.8.8.8 8.8.4.4 valid=300s;
   resolver_timeout 5s;
   {% endif %}
   server_name  {{ DOMAINLIST }};
   access_log /usr/local/apache/domlogs/{{ DOMAINNAME }}-ssl_log combined buffer=32k flush=5m;
   access_log /usr/local/apache/domlogs/{{ DOMAINNAME }}-bytes_log bytes_log buffer=32k flush=5m;
   {% if AUTOINDEX == 1 }
   autoindex on;
   {% endif %}
   {% if HSTS == 1 }
   add_header Strict-Transport-Security "max-age=86400;";
   {% endif %}
   {% if BLOCK_SQL_INJECTION == 1 }
   set $block_sql_injections 0;
   if ($query_string ~ "union.*select.*\(") {
   set $block_sql_injections 1;
   }
   if ($query_string ~ "union.*all.*select.*") {
   set $block_sql_injections 1;
   }
   if ($query_string ~ "concat.*\(") {
   set $block_sql_injections 1;
   }
   if ($block_sql_injections = 1) {
   return 403;
   }
   {% endif %}
   {% if BLOCK_FILE_INJECTION == 1 }
   set $block_file_injections 0;
   if ($query_string ~ "[a-zA-Z0-9_]=http://") {
    set $block_file_injections 1;
   }
   if ($query_string ~ "[a-zA-Z0-9_]=(\.\.//?)+") {
    set $block_file_injections 1;
   }
   if ($query_string ~ "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") {
    set $block_file_injections 1;
   }
   if ($block_file_injections = 1) {
    return 403;
   }
   {% endif %}
   {% if BLOCK_COMMON_EXPLOITS == 1 }
   set $block_common_exploits 0;
   if ($query_string ~ "(<|%3C).*script.*(>|%3E)") {
     set $block_common_exploits 1;
   }
   if ($query_string ~ "GLOBALS(=|\[|\%[0-9A-Z]{0,2})") {
     set $block_common_exploits 1;
   }
   if ($query_string ~ "_REQUEST(=|\[|\%[0-9A-Z]{0,2})") {
     set $block_common_exploits 1;
   }
   if ($query_string ~ "proc/self/environ") {
     set $block_common_exploits 1;
   }
   if ($query_string ~ "mosConfig_[a-zA-Z_]{1,21}(=|\%3D)") {
     set $block_common_exploits 1;
   }
   if ($query_string ~ "base64_(en|de)code\(.*\)") {
     set $block_common_exploits 1;
   }
   if ($block_common_exploits = 1) {
     return 403;
   }
   {% endif %}
   {% if BLOCK_SPAM == 1 }
   set $block_spam 0;
   if ($query_string ~ "\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b") {
     set $block_spam 1;
   }
   if ($query_string ~ "\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b") {
     set $block_spam 1;
   }
   if ($query_string ~ "\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b") {
     set $block_spam 1;
   }
   if ($query_string ~ "\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b") {
     set $block_spam 1;
   }
   if ($block_spam = 1) {
     return 403;
   }
   {% endif %}
   {% if BLOCK_BAD_USER_AGENT == 1 }
   set $block_user_agents 0;
   if ($http_user_agent ~ "Indy Library") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "libwww-perl") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "GetRight") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "GetWeb!") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "Go!Zilla") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "Download Demon") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "Go-Ahead-Got-It") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "TurnitinBot") {
     set $block_user_agents 1;
   }
   if ($http_user_agent ~ "GrabNet") {
     set $block_user_agents 1;
   }
   if ($block_user_agents = 1) {
     return 403;
   {% endif %}

   include /etc/nginx/sites-enabled/{{ DOMAINNAME }}.include;
}
{% endif %}
